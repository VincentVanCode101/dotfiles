#!/usr/bin/env bash
set -euo pipefail

# --- Check for mdanki
command -v mdanki >/dev/null 2>&1 || {
    echo "Error: mdanki not found in \$PATH. Check out https://github.com/VincentVanCode101/docker-apps.git to install it" >&2
    exit 1
}

# --- Validate input
if [[ $# -lt 1 ]]; then
  echo "Usage: $0 <input-file>"
  exit 1
fi

INPUT="$1"
SRC="$(cd "$(dirname "$INPUT")" && pwd)/$(basename "$INPUT")"
echo "Resolved SRC: '$SRC'"

if [[ ! -f "$SRC" ]]; then
  echo "File '$SRC' does not exist!"
  exit 1
fi

echo "File exists. Continuing..."

DIR=$(dirname "$SRC")
BASE=$(basename "$SRC")        # e.g., books.md
NAME=${BASE%.*}                # e.g., books
EXT=${BASE##*.}                # e.g., md

PROCESSED_FILE="$DIR/${NAME}-processed.${EXT}"
APKG="$DIR/${NAME}.apkg"

# --- if a plain-named .apkg exists, add a datestamp
if [[ -f $APKG ]]; then
    APKG="$DIR/${NAME}-$(date +%Y%m%d-%H%M%S).apkg"
fi

echo "INPUT   : $SRC"
echo "OUTPUT  : $APKG"
echo "DECK    : $NAME"
echo "PROCESSED TARGET : $PROCESSED_FILE"
echo

# --- Run mdanki
mdanki "$SRC" "$APKG" --deck "$NAME"

# --- Function to trim leading/trailing blank lines (but preserve line order)
trim_blanks() {
    # Remove leading and trailing blank lines, including space/tab-only lines
    awk 'NF {p=1} p' "$1" | awk '{if (NF || prev) print; prev=NF}'
}

# --- Archive input content
if [[ -f $PROCESSED_FILE ]]; then
    tmp_file=$(mktemp)

    # Trim existing processed file
    trim_blanks "$PROCESSED_FILE" > "$tmp_file"

    # Ensure there's a blank line before appending new notes
    printf '\n\n' >> "$tmp_file"

    # Append cleaned-up new content
    trim_blanks "$SRC" >> "$tmp_file"

    mv "$tmp_file" "$PROCESSED_FILE"
else
    # First run - create the processed file
    trim_blanks "$SRC" > "$PROCESSED_FILE"
    printf '\n' >> "$PROCESSED_FILE"
fi

# --- Delete the input file after archiving
rm "$SRC"

echo "Done."
echo "Created  : $APKG"
echo "Archived : $PROCESSED_FILE"
